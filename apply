#!/bin/sh
# yes the shell
# 2010-08-31 Kacper Wysocki <comotion@krutt.org> Initial version
# 
# bottom up is better than top down
# 
# git clone repo/gone ; cd gone; ./apply

# let defaults be default: fall back to logic
fqdn=`hostname -f`
host=`hostname`

# hostname, $fqdn or other specifics are kept in branches
git checkout $host 2>/dev/null
git checkout $fqdn 2>/dev/null

git branch
# weakness: one machine may have many roles, not in this scheme though
# edit: keep separate repos for each role...
# or keep the same files and figure out a way to do multiple inheritance

# substitute installed copies for version controlled ones
workdir=$PWD
cd files/
for file in `find . -type f | sed 's/^.\///'`
do
    echo $file
	if ! diff -bud /$file $file || [ $? = 2 ]
	then
		echo "$file doesn't match local copy, [a]pply, commit or SKIP?"
		read choose
		case $choose in
			[aA])
			cp -v $file /$file
			;;

			commit)
			cp -v /$file $file
			git diff $file
			git add $file
			git commit
			;;
			
			*)
            # skip
		esac
	fi
done
cd $workdir

# kick the script - basically what chef, slaughter and puppet does
. $workdir/defaults
# dash doesn't like it when we source relative scripts :-(

